# Claude Remote 仕様書

## 概要
Claude RemoteはAndroidのObsidianから作成したメモを元に、Ubuntu PC上でClaude Codeを自動実行するシステムです。

## システム構成

### 1. Android側
- Obsidianでマークダウン形式のメモを作成
- Google Driveで自動同期

### 2. Ubuntu PC側
- Google Driveをローカルにマウント
- 指定ディレクトリ内のファイル更新を監視
- 更新検知時にClaude Codeを自動実行
- 実行完了後Slackに通知

## 詳細仕様

### Obsidianメモの形式
- マークダウンファイル全体がClaude Codeへの指示として扱われる
- 音声入力対応のため、特殊な記法は使用しない
- コマンドラインオプションも含めて記述可能

### ファイル監視
- **ハッシュベースファイル監視** (`hash_file_watcher.py`) を採用
- MD5ハッシュによる内容変更検知で確実性を向上
- ファイルハッシュのキャッシュ機能で高速化
- システムによる自動変更（質問追記等）を除外
- ポーリング間隔1秒で軽量動作

### 作業ディレクトリ管理
- 初回実行：自動的に作業ディレクトリを決定
- 更新時：前回と同じ作業ディレクトリを使用
- マークダウン内で明示的に指定も可能

### 実行方式
- **直接実行モード**: シェル経由でclaude CLIを直接実行（現在のデフォルト）
- **Dockerモード**: コンテナ隔離実行（セキュリティ重視時）
- 実行タイムアウト: 30分（設定可能）
- 許可ツール: Write,Edit,MultiEdit,Read,Bash,Glob,Grep

### プロジェクト管理
- マークダウンファイルごとに別プロジェクトとして管理
- 生成コードはGoogle Driveとは別の場所に保存
- 実行ログはプロジェクトディレクトリ内に保存

### Claude Code実行時の動作
- 各プロジェクトにCLAUDE.mdを作成して仕様を記載
- 仕様を決めるために追加情報が必要な場合：
  - Slackに質問を通知
  - 元のマークダウンファイルに質問事項を追記
  - ユーザーが回答を埋めるまで待機

### エラー処理
- エラー発生時はSlackに通知
- 実行中の新規更新は無視し、実行完了後に処理

### 実行環境
- Claude CodeはDockerコンテナ内で実行
- 必要なリソースとネットワークアクセスを制限

### 通知
- Slack webhookを使用して実行完了を通知
- 実行したタスクの概要を含める
- 生成されたコード自体は含めない

## ネットワークアクセス制限
- ホワイトリスト方式を採用
- 許可するサービス：
  - Claude CodeのAPIエンドポイント
  - npm/pip等のパッケージマネージャーのレジストリ
  - 必要なGitリポジトリ

## タイムアウト設定について

Claude Codeのタイムアウトが必要な場合：
1. **無限ループの防止** - 誤った指示によるハング
2. **リソース保護** - 長時間実行によるシステム負荷
3. **料金管理** - API使用量の制限
4. **デッドロック検出** - ファイル操作等での待機

設定値：
- タイムアウト：30分

## ディレクトリ構造

```
<PROJECTS_DIR>/  # プロジェクト保存先（.envで設定可能、デフォルト: ./projects）
  /<仮プロジェクト名_timestamp>/  # 初回は仮名
    /CLAUDE.md
    /src/
    /logs/
    /.project_info.json  # プロジェクト情報（正式名など）
<GDRIVE_MOUNT_PATH>/  # Google Driveマウント先（.envで設定可能、デフォルト: /gdrive/claude-remote）
  # 監視対象ディレクトリ
```

## プロジェクト管理
- 新規作成時：`project_<timestamp>` 形式の仮名
- CLAUDE.md作成後に正式名を決定
- ユーザーは後からプロジェクト名を変更可能

## Slack通知
- 実行開始時：プロジェクト名とタスク概要
- 実行完了時：結果サマリー
- エラー時：3段階のエラーレベル
  - 軽微：再試行で解決可能なエラー
  - 重要：ユーザー対応が必要なエラー
  - 致命的：システムエラー（スタックトレース含む）

## 実行管理
- 同時実行数：最大3つ
- キュー管理で順次実行

## トークン制限対応
- トークン制限エラーを検出
- 5分間隔で再試行（最大10回）
- 再試行状況をSlackに通知

## 開発言語・依存関係
- **Python 3.8以上**
- **パッケージ管理**: uv（高速モダンパッケージマネージャー）
- **主要ライブラリ**:
  - `requests`: Slack通知HTTP通信
  - `docker`: Dockerコンテナ制御
  - `python-dotenv`: 環境変数管理
  - `pathlib`: モダンなパス操作
  - `asyncio`: 非同期並行処理
  - `hashlib`: ファイル内容ハッシュ計算
  - `logging`: 構造化ログ出力

## 実装完了事項

### ✅ 完成したコンポーネント
1. **ハッシュベースファイル監視** (`hash_file_watcher.py`)
   - MD5ハッシュによる確実な内容変更検知
   - ファイルハッシュキャッシュシステム（`~/.claude-remote/cache/`）
   - システム変更除外機能（質問追記時の無限ループ防止）
   - 軽量ポーリング（1秒間隔）

2. **プロジェクト管理** (`project_manager.py`)
   - 仮プロジェクト名の自動生成
   - プロジェクト情報の永続化
   - プロジェクト名の変更機能

3. **Claude Code実行エンジン** (`claude_executor.py`)
   - **直接実行**: シェル経由claude CLI実行（メインモード）
   - **Docker実行**: コンテナ隔離実行（セキュリティモード）
   - 厳密なツール権限制御（Write,Edit,MultiEdit,Read,Bash,Glob,Grep）
   - タイムアウト制御（30分、設定可能）
   - トークン制限時の自動再試行（5分間隔、最大10回）
   - 詳細な実行ログ保存
   - **質問検出・自動追記機能**: 正規表現による質問検出＋マークダウン追記

4. **Slack通知システム** (`slack_notifier.py`)
   - リッチブロック形式の通知デザイン
   - 実行開始・完了・エラーの段階別通知
   - 3段階エラーレベル（minor/major/critical）
   - ソースファイル名の表示
   - トークン制限再試行状況の通知

5. **設定管理** (`config.py`)
   - 環境変数ベースの設定システム
   - 設定値の検証と初期化
   - パス設定の柔軟性（PROJECTS_DIR, GDRIVE_MOUNT_PATH）
   - Docker設定の統合管理

6. **メインアプリケーション** (`main.py`)
   - 非同期タスク管理（最大3並行実行）
   - グレースフルシャットダウン（Ctrl+C対応）
   - 初回実行時の対話型セットアップ
   - 実行タスクの重複防止機能
   - エラー処理とリカバリー機能

### 📁 ディレクトリ構造（実装済み）
```
claude-remote/
├── claude_remote/          # 実装済みソースコード
│   ├── main.py            # ✅ メインアプリケーション
│   ├── hash_file_watcher.py # ✅ ハッシュベースファイル監視
│   ├── file_watcher.py    # ✅ 旧ファイル監視（Git連携版）
│   ├── claude_executor.py # ✅ Claude Code実行機能
│   ├── slack_notifier.py  # ✅ Slack通知機能
│   ├── project_manager.py # ✅ プロジェクト管理
│   ├── config.py          # ✅ 設定管理
│   └── __init__.py        # ✅ パッケージ初期化
├── docker/                # ✅ Docker設定
│   ├── Dockerfile         # ✅ Claude CLI環境
│   └── docker-compose.yml # ✅ オーケストレーション
├── projects/              # ✅ プロジェクト保存先（.envで設定可能）
├── requirements.txt       # ✅ 依存関係
├── .env.example          # ✅ 設定テンプレート
├── run.py                # ✅ 実行スクリプト
├── README.md             # ✅ 詳細ドキュメント
└── CLAUDE.md             # ✅ プロジェクト仕様書
```

### 🚀 セットアップ手順（確認済み）
1. ✅ 依存関係のインストール
2. ✅ 設定ファイルの作成
3. ✅ Docker環境の構築
4. ✅ 実行スクリプトの準備
5. ✅ 包括的なドキュメント

### 🔧 実装済み機能詳細
- **高精度ファイル監視**: MD5ハッシュベースの確実な変更検知
- **キャッシュシステム**: ファイルハッシュの永続化で高速起動
- **システム変更除外**: 質問追記等による無限ループ防止
- **柔軟な実行方式**: 直接実行（高速）とDocker実行（安全）の切り替え
- **厳格なツール制限**: 最小限の権限（7つのツール）でセキュリティ確保
- **インテリジェント質問検出**: 正規表現＋自然言語パターンでClaude応答を解析
- **プロジェクト自動管理**: 仮名→正式名の移行とディレクトリ管理
- **トークン制限対応**: 指数バックオフによる自動再試行
- **非同期並行実行**: 最大3プロジェクトの効率的な同時処理
- **リッチ通知**: Slackブロック形式での詳細な実行状況通知
- **音声入力最適化**: 特殊記法不要でObsidian音声入力に対応
- **環境変数設定**: 全ての設定項目を.envで柔軟に管理

## 次のステップ（オプション）
1. **テストスイートの作成** - 単体テスト・結合テストの実装
2. **Web UI** - ブラウザベースの管理画面（オプション）
3. **メトリクス収集** - 実行統計とパフォーマンス監視
4. **CI/CD統合** - GitHub ActionsやGitLab CIとの連携
5. **プラグインシステム** - カスタム処理の追加機能

## 実装品質
- **コード品質**: 型ヒント、ドキュメンテーション、エラーハンドリング
- **セキュリティ**: Docker隔離、ネットワーク制限、リソース制限
- **パフォーマンス**: 非同期処理、並行実行、デバウンス機能
- **運用性**: 詳細ログ、設定管理、グレースフルシャットダウン